#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include <X11/XKBlib.h>
#include <X11/keysym.h>

int xna_keycode_to_x11_sym[] = {-1, -1, -1, 0xff69, -1, -1, -1, -1, 0xff08, 0xff09, -1, -1, 0xff0b, 0xff0d, -1, -1, -1, -1, 0xff67, 0xff13, -1, 0xff31, -1, -1, -1, 0xff21, -1, 0xff1b, -1, -1, -1, -1, 0x0020, 0xff55, 0xff56, 0xff57, 0xff50, 0xff51, 0xff52, 0xff53, 0xff54, 0xff60, 0xff61, 0xff62, -1, 0xff63, 0xffff, 0xff6a, 0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037, 0x0038, 0x0039, -1, -1, -1, -1, -1, -1, -1, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067, 0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f, 0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077, 0x0078, 0x0079, 0x007a, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0x00d7, -1, -1, -1, -1, -1, 0xffbe, 0xffbf, 0xffc0, 0xffc1, 0xffc2, 0xffc3, 0xffc4, 0xffc5, 0xffc6, 0xffc7, 0xffc8, 0xffc9, 0xffca, 0xffcb, 0xffcc, 0xffcd, 0xffce, 0xffcf, 0xffd0, 0xffd1, 0xffd2, 0xffd3, 0xffd4, 0xffd5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0xffe1, 0xffe2, 0xffe3, 0xffe4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0x003d, -1, 0x002d, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0x005b};

char LinGetAsyncKeyState(int xna_keycode){
    char keys[32];

    Display* dpy = XOpenDisplay(NULL);

    int x11_keysym = xna_keycode_to_x11_sym[xna_keycode];

    if(x11_keysym == -1){
       return 0; 
    }

    int keycode = XKeysymToKeycode(dpy, x11_keysym);

    XQueryKeymap(dpy, keys);

    char key_bit = keys[keycode/8] & (0x1 << (keycode % 8));

    XCloseDisplay(dpy);

    return key_bit != 0;
}
